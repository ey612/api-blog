<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‚˜ì˜ ë¸”ë¡œê·¸</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
    }
    h1 {
      margin-top: 0;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
    }
    button {
      padding: 8px 16px;
      margin-right: 8px;
      cursor: pointer;
    }
    .post {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
      cursor: pointer;
    }
    .error {
      color: red;
      margin-bottom: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>

<div class="container" id="app"></div>

<script>
const API_BASE = 'http://localhost:5000/api';
let currentUser = null;
let currentPost = null;

/* ================= ë Œë” í•¨ìˆ˜ ================= */

function renderLogin() {
  document.getElementById('app').innerHTML = `
    <h1>ë¡œê·¸ì¸</h1>
    <div class="error" id="error"></div>
    <input id="email" placeholder="ì´ë©”ì¼" />
    <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <button onclick="renderRegister()">íšŒì›ê°€ì…</button>
  `;
}

function renderRegister() {
  document.getElementById('app').innerHTML = `
    <h1>íšŒì›ê°€ì…</h1>
    <div class="error" id="error"></div>
    <input id="username" placeholder="ì´ë¦„" />
    <input id="email" placeholder="ì´ë©”ì¼" />
    <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <button onclick="register()">ê°€ì…</button>
    <button onclick="renderLogin()">ë’¤ë¡œ</button>
  `;
}

function renderPosts(posts) {
  document.getElementById('app').innerHTML = `
    <div class="header">
      <h1>ë‚˜ì˜ ë¸”ë¡œê·¸</h1>
      <div>
        ğŸ‘¤ ${currentUser.username}
        <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
    <button onclick="renderCreate()">âœï¸ ê¸€ ì‘ì„±</button>
    <div>
      ${posts.map(p => `
        <div class="post" onclick="viewPost(${p.id})">
          <strong>${p.title}</strong><br/>
          ì‘ì„±ì ID: ${p.user_id}
        </div>
      `).join('')}
    </div>
  `;
}

function renderDetail(post) {
  document.getElementById('app').innerHTML = `
    <h1>${post.title}</h1>
    <p>${post.content}</p>
    <button onclick="loadPosts()">ëª©ë¡</button>
    ${post.user_id === currentUser.id ? `
      <button onclick="renderEdit()">ìˆ˜ì •</button>
      <button onclick="deletePost(${post.id})">ì‚­ì œ</button>
    ` : ''}
  `;
}

function renderCreate() {
  document.getElementById('app').innerHTML = `
    <h1>ê¸€ ì‘ì„±</h1>
    <input id="title" placeholder="ì œëª©" />
    <textarea id="content" placeholder="ë‚´ìš©"></textarea>
    <button onclick="createPost()">ì‘ì„±</button>
    <button onclick="loadPosts()">ì·¨ì†Œ</button>
  `;
}

function renderEdit() {
  document.getElementById('app').innerHTML = `
    <h1>ê¸€ ìˆ˜ì •</h1>
    <input id="title" value="${currentPost.title}" />
    <textarea id="content">${currentPost.content}</textarea>
    <button onclick="updatePost()">ì €ì¥</button>
    <button onclick="viewPost(${currentPost.id})">ì·¨ì†Œ</button>
  `;
}

/* ================= API í•¨ìˆ˜ ================= */

async function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  const res = await fetch(`${API_BASE}/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();

  if (res.ok && data.user) {
    currentUser = data.user;
    loadPosts();
  } else {
    document.getElementById('error').innerText =
      data.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
  }
}

async function register() {
  const username = document.getElementById('username').value;
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  const res = await fetch(`${API_BASE}/register`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, email, password })
  });

  if (res.ok) {
    alert('íšŒì›ê°€ì… ì„±ê³µ');
    renderLogin();
  } else {
    document.getElementById('error').innerText = 'íšŒì›ê°€ì… ì‹¤íŒ¨';
  }
}

async function loadPosts() {
  const res = await fetch(`${API_BASE}/posts`);
  const posts = await res.json();
  renderPosts(posts);
}

async function viewPost(id) {
  const res = await fetch(`${API_BASE}/posts/${id}`);
  currentPost = await res.json();
  renderDetail(currentPost);
}

async function createPost() {
  const title = document.getElementById('title').value;
  const content = document.getElementById('content').value;

  await fetch(`${API_BASE}/posts`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, content, user_id: currentUser.id })
  });

  loadPosts();
}

async function updatePost() {
  const title = document.getElementById('title').value;
  const content = document.getElementById('content').value;

  await fetch(`${API_BASE}/posts/${currentPost.id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title, content })
  });

  loadPosts();
}

async function deletePost(id) {
  if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;

  await fetch(`${API_BASE}/posts/${id}`, { method: 'DELETE' });
  loadPosts();
}

function logout() {
  currentUser = null;
  renderLogin();
}

/* ================= ì‹œì‘ ================= */
renderLogin();
</script>
</body>
</html>
